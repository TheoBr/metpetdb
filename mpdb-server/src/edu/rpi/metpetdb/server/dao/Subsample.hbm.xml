<!DOCTYPE hibernate-mapping PUBLIC
    "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
    "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">

<hibernate-mapping package="edu.rpi.metpetdb.server.model">
  <class name="Subsample" table="subsamples">
    <id name="id" column="subsample_id" unsaved-value="0">
      <generator class="sequence">
        <param name="sequence">subsample_seq</param>
      </generator>
    </id>
    <version name="version" />
    <property name="name" column="name" />
    
    <property name="imageCount" formula="(select count(*) from images i
    																		where i.subsample_id=subsample_id)" />
	<property name="analysisCount" formula="(select count(*) from chemical_analyses ca
    																		where ca.subsample_id=subsample_id)" />
    <property name="sampleName" formula="(select s.alias from samples s
    																		where s.sample_id=sample_id)" />
    
    <many-to-one name="sample" column="sample_id" class="Sample" lazy="false"/>
    <many-to-one name="subsampleType" column="subsample_type_id" class="SubsampleType" lazy="false" />
    
    <one-to-one name="grid" property-ref="subsample" />
   
   <set name="images" table="images" cascade="all-delete-orphan" lazy="false"> 
      <key column="subsample_id" />
      <one-to-many class="Image" />
    </set>
    
    <set name="chemicalAnalyses" inverse="true" table="chemical_analyses" cascade="all"> 
      <key column="subsample_id" />
      <one-to-many class="ChemicalAnalysis" />
    </set>
    
  </class>

  <query name="Subsample.byId">
    from Subsample s
    where s.id = :id
  </query>
  
  <query name="Subsample.bySample.byName">
    from Subsample s
    where s.sample.id = :id
    and s.name = :name
  </query>
  
   <query name="Subsample.bySampleId,size">
    select count(*) from Subsample s
    where s.sample.id = :id
  </query>
  
  <query name="Subsample.bySampleId">
  	from Subsample s
  	where s.sample.id = :sampleId
  </query>
  
  <query name="Subsample.allWithImages,size">
    select count(*) from Subsample s
    where s.sample.id = :id and size( s.images ) > 0
  </query>
  <query name="Subsample.allWithImages/name">
    from Subsample s
    where s.sample.id = :id and size( s.images ) > 0
    order by s.name
  </query>
  <query name="Subsample.all,size">
    select count(*) from Subsample s
    where s.sample.id = :id
  </query>
  <query name="Subsample.all/name">
    from Subsample s
    where s.sample.id = :id
    order by s.name
  </query>
</hibernate-mapping>