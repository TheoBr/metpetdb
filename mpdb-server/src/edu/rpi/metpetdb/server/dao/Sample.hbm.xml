<!DOCTYPE hibernate-mapping PUBLIC
    "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
    "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">

<hibernate-mapping package="edu.rpi.metpetdb.client.model">
  <class name="Sample" table="samples">
    <id name="id" column="sample_id" unsaved-value="0">
      <generator class="sequence">
        <param name="sequence">sample_seq</param>
      </generator>
    </id>
    <version name="version" />
    <property name="sesarNumber" column="sesar_number" length="9" />
    <property name="location" column="location"
              type="edu.rpi.metpetdb.server.dao.GeometryType" />
    <property name="alias" column="alias" length="20" />
    <property name="collectionDate" column="collection_date" />
    <property name="datePrecision" column="date_precision" />
    <property name="publicData" column="public_data" type="yes_no" />
    <property name="country" column="country" length="100" />
    <property name="description" column="description" length="100" />
    <property name="collector" column="collector" length="100" />
    <property name="locationText" column="location_text" length="50" />
    <property name="latitudeError" column="latitude_error" />
    <property name="longitudeError" column="longitude_error" />
    
    <property name="subsampleCount" formula="(select count(*) from subsamples s
    																		where s.sample_id=sample_id)" />
    
    
    <many-to-one name="owner" column="user_id" lazy="false" />
    <many-to-one name="rockType" column="rock_type_id" lazy="false" />

	<set name="subsamples" inverse="true" cascade="all" >
      <key column="sample_id"/>
      <one-to-many class="Subsample" />
    </set>
    
    <set name="comments" cascade="all,delete-orphan" lazy="false" >
      <key column="sample_id" not-null="true"/>
      <one-to-many class="SampleComment" />
    </set>
    
    <set name="projects" table="project_samples" cascade="none">
      <key column="sample_id" />
      <many-to-many class="Project" column="project_id" />
    </set>

    <set name="regions" table="sample_regions" cascade="persist,merge" lazy="false">
      <key column="sample_id" />
      <many-to-many class="Region" column="region_id" />
    </set>

    <set name="metamorphicGrades" table="sample_metamorphic_grades" cascade="none" lazy="false">
      <key column="sample_id" />
      <many-to-many class="MetamorphicGrade" column="metamorphic_grade_id" />
    </set>

    <set name="references" table="sample_reference" cascade="persist,merge" lazy="false">
      <key column="sample_id" />
      <many-to-many class="Reference" column="reference_id" />
    </set>

    <set name="images" inverse="true" lazy="false">
      <key column="sample_id" />
      <one-to-many class="Image" />
    </set>
    
    <!-- Hibernate updates sets by using insert/delete, not update -->
    <set name="minerals" table="sample_minerals" cascade="save-update" lazy="false">
      <key column="sample_id" />
      <composite-element class="SampleMineral">
      	<!--Composite elements CANNOT be null with a set -->
      	<property name="amount" column="amount" type="float" not-null="true"/>
	    <many-to-one name="mineral" class="Mineral" column="mineral_id" lazy="false"/>
	  </composite-element>
    </set>
    
    <filter name="boundingBox"
            condition="ST_Intersects(location, :polygon)" 
            />
            
     <filter name="user"
     		condition="user_id=:id" />
     		
     <filter name="public"
     		condition="public_data='Y'" />
  </class>
  
  

  <query name="Sample.byId">
    from Sample s
    inner join fetch s.owner
    where s.id = :id
  </query>
  <query name="Sample.all,size">
    select count(*) from Sample s
  </query>
  <query name="Sample.all/sesarNumber">
    from Sample s
    inner join fetch s.owner
    order by s.sesarNumber
  </query>
  <query name="Sample.all/alias">
    from Sample s
    inner join fetch s.owner
    order by lower(s.alias)
  </query>
  <query name="Sample.all/owner">
    from Sample s
    inner join fetch s.owner
    order by lower(s.owner.name)
  </query>
  <query name="Sample.all/rockType">
    from Sample s
    inner join fetch s.owner
    order by s.rockType
  </query>
  <query name="Sample.all/collectionDate">
    from Sample s
    inner join fetch s.owner
    order by s.collectionDate
  </query>
  <query name="Sample.all/publicData">
    from Sample s
    inner join fetch s.owner
    order by s.publicData
  </query>
  <query name="Sample.all/latitude">
    from Sample s
    inner join fetch s.owner
    order by s.location
  </query>
  <query name="Sample.all/longitude">
    from Sample s
    inner join fetch s.owner
    order by s.location
  </query>
  <query name="Sample.all/country">
    from Sample s
    inner join fetch s.owner
    order by lower(s.country)
  </query>
  <query name="Sample.all/collector">
    from Sample s
    inner join fetch s.owner
    order by lower(s.collector)
  </query>
  <query name="Sample.all/locationText">
    from Sample s
    inner join fetch s.owner
    order by lower(s.locationText)
  </query>
  <query name="Sample.all/latitudeError">
    from Sample s
    inner join fetch s.owner
    order by s.latitudeError
  </query>
  <query name="Sample.all/longitudeError">
    from Sample s
    inner join fetch s.owner
    order by s.longitudeError
  </query>
  <query name="Sample.byUser.byAlias">
    from Sample s
    inner join fetch s.owner
    where s.owner.id = :id
    and s.alias = :alias
  </query>
  
  <query name="Sample.forProject,size">
  	select count(*) from Sample s
  	inner join s.projects as project with project.id = :id
  </query>
  <query name="Sample.forProject/alias">
  	select s from Sample s
  	inner join s.projects as project with project.id = :id
  	order by s.alias
  </query>
  
  <query name="Sample.Collectors/Collector">
    Select Distinct collector
    from Sample s
    where s.publicData = 'Y'
    order by s.collector
  </query>
  <query name="Sample.Countries/Countries">
    Select Distinct country
    from Sample s
    order by s.country
  </query>
  
  <filter-def name="boundingBox">
    <filter-param name="polygon" type="edu.rpi.metpetdb.server.dao.GeometryType"/>
  </filter-def>
  
  <filter-def name="user">
    <filter-param name="id" type="long"/>
  </filter-def>
  <filter-def name="public">
  </filter-def>

</hibernate-mapping>